<!DOCTYPE html>
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<!-- import three.js and ar-threex library as a module-->
<script type="importmap">
	{
      "imports": {
		"threex": "./js/ar-threex.mjs",
        "three": "https://cdn.jsdelivr.net/npm/three@0.175.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.175.0/examples/jsm/"
      }
    }
</script>

<body style='font-family: Monospace; margin: 0; overflow: hidden;'>
    <div id="loading"
        style="position: absolute; top: 10px; left: 10px; background-color: rgba(0,0,0,0.6); color: white; padding: 10px; z-index: 999;">
        Loading 3D model, please wait...
    </div>
    <div id="error"
        style="display: none; position: absolute; top: 10px; left: 10px; background-color: rgba(255,0,0,0.6); color: white; padding: 10px; z-index: 999;">
    </div>
    <div id="mode-switch"
        style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(0,0,0,0.6); color: white; padding: 10px; z-index: 999; border-radius: 5px;">
        <button id="ar-mode" style="padding: 8px 15px; margin-right: 10px; cursor: pointer;">AR Mode</button>
        <button id="3d-mode" style="padding: 8px 15px; cursor: pointer;">3D Mode</button>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { ArToolkitSource, ArToolkitContext, ArMarkerControls } from 'threex';

        // 设置AR基础URL
        ArToolkitContext.baseURL = './';

        // 全局变量
        let scene, camera, renderer, model;
        let controls;
        let arToolkitSource, arToolkitContext, arMarkerControls;
        let mixer;
        let clock = new THREE.Clock();
        let isARMode = false;

        // 初始化场景
        initScene();

        // 初始化AR模式按钮
        document.getElementById('ar-mode').addEventListener('click', enableARMode);
        document.getElementById('3d-mode').addEventListener('click', enable3DMode);
        
        // 默认进入3D模式
        enable3DMode();

        // 创建场景、相机和渲染器
        function initScene() {
            scene = new THREE.Scene();
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setClearColor(new THREE.Color('lightgrey'), 0);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.outputEncoding = THREE.sRGBEncoding;
            renderer.domElement.style.position = 'absolute';
            renderer.domElement.style.top = '0px';
            renderer.domElement.style.left = '0px';
            document.body.appendChild(renderer.domElement);

            // 加载模型
            loadModel();

            // 处理窗口大小变化
            window.addEventListener('resize', onWindowResize);
        }

        function enable3DMode() {
            isARMode = false;
            
            // 移除可能存在的AR相机
            if (scene.getObjectByName('ar-camera')) {
                scene.remove(scene.getObjectByName('ar-camera'));
            }
            
            // 设置透视相机
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 2, 5);
            camera.lookAt(0, 0, 0);
            camera.name = '3d-camera';
            scene.add(camera);

            // 添加OrbitControls
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            // 添加辅助对象
            addHelpers();
            
            // 添加灯光
            addLights();

            // 更新按钮状态
            document.getElementById('3d-mode').style.backgroundColor = '#4CAF50';
            document.getElementById('ar-mode').style.backgroundColor = '';

            // 开始渲染循环
            animate3D();
            
            // 显示模型
            if (model) {
                model.visible = true;
                // 重新定位模型到场景中心
                centerModel();
            }
        }
        
        function enableARMode() {
            isARMode = true;
            
            // 清除3D模式元素
            if (controls) {
                controls.dispose();
                controls = null;
            }
            
            // 移除辅助对象
            removeHelpers();
            
            // 设置AR相机
            camera = new THREE.Camera();
            camera.name = 'ar-camera';
            scene.add(camera);
            
            // 初始化AR
            initARToolkit();
            
            // 更新按钮状态
            document.getElementById('ar-mode').style.backgroundColor = '#4CAF50';
            document.getElementById('3d-mode').style.backgroundColor = '';
            
            // 开始AR渲染循环
            animateAR();
        }
        
        function initARToolkit() {
            // 创建AR源
            arToolkitSource = new ArToolkitSource({
                sourceType: 'webcam',
                sourceWidth: window.innerWidth,
                sourceHeight: window.innerHeight,
                displayWidth: window.innerWidth,
                displayHeight: window.innerHeight,
            });

            arToolkitSource.init(function onReady() {
                arToolkitSource.domElement.addEventListener('canplay', () => {
                    console.log(
                        'AR camera ready:',
                        arToolkitSource.domElement.videoWidth,
                        arToolkitSource.domElement.videoHeight
                    );
                    initARContext();
                });
                
                setTimeout(() => {
                    onWindowResize();
                }, 2000);
            });
        }
        
        function initARContext() {
            // 创建AR上下文
            arToolkitContext = new ArToolkitContext({
                cameraParametersUrl: ArToolkitContext.baseURL + './models/camera_para.dat',
                detectionMode: 'mono'
            });
            
            // 初始化AR上下文
            arToolkitContext.init(() => {
                // 复制投影矩阵到相机
                camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
                
                arToolkitContext.arController.orientation = getSourceOrientation();
                arToolkitContext.arController.options.orientation = getSourceOrientation();
            });
            
            // 创建AR标记控制器
            arMarkerControls = new ArMarkerControls(arToolkitContext, camera, {
                type: 'pattern',
                patternUrl: ArToolkitContext.baseURL + 'pattern-marker.patt',
                changeMatrixMode: 'cameraTransformMatrix'
            });
            
            // 重新调整模型大小和位置以适应AR
            if (model) {
                adjustModelForAR();
            }
        }
        
        function getSourceOrientation() {
            if (!arToolkitSource) {
                return null;
            }
            
            if (arToolkitSource.domElement.videoWidth > arToolkitSource.domElement.videoHeight) {
                return 'landscape';
            } else {
                return 'portrait';
            }
        }
        
        function adjustModelForAR() {
            // 调整模型比例和位置以适合AR显示
            model.scale.set(0.05, 0.05, 0.05); // 可能需要调整
            model.position.set(0, 0, 0);
            model.rotation.x = -Math.PI/2; // 调整方向
        }
        
        function centerModel() {
            if (!model) return;
            
            // 计算模型的边界框
            const box = new THREE.Box3().setFromObject(model);
            const center = new THREE.Vector3();
            box.getCenter(center);
            
            // 将模型居中
            model.position.sub(center);
            
            // 计算适当的缩放比例
            const size = new THREE.Vector3();
            box.getSize(size);
            const maxDimension = Math.max(size.x, size.y, size.z);
            const scale = 1 / maxDimension; // 缩放到单位大小
            model.scale.set(scale, scale, scale);
        }
        
        function addHelpers() {
            // 添加坐标轴和网格辅助
            const axesHelper = new THREE.AxesHelper(5);
            axesHelper.name = 'axes-helper';
            scene.add(axesHelper);
            
            const gridHelper = new THREE.GridHelper(10, 10);
            gridHelper.name = 'grid-helper';
            scene.add(gridHelper);
        }
        
        function removeHelpers() {
            // 移除辅助对象
            scene.remove(scene.getObjectByName('axes-helper'));
            scene.remove(scene.getObjectByName('grid-helper'));
        }
        
        function addLights() {
            // 添加环境光
            const ambientLight = new THREE.AmbientLight(0xffffff, 1);
            scene.add(ambientLight);
            
            // 添加方向光
            const directionalLight1 = new THREE.DirectionalLight(0xffffff, 2);
            directionalLight1.position.set(5, 10, 7);
            scene.add(directionalLight1);
            
            const directionalLight2 = new THREE.DirectionalLight(0xffffff, 2);
            directionalLight2.position.set(-5, -10, -7);
            scene.add(directionalLight2);
            
            // 添加点光源
            const pointLight = new THREE.PointLight(0xffffff, 2);
            pointLight.position.set(0, 5, 5);
            scene.add(pointLight);
        }
        
        function loadModel() {
            const loader = new GLTFLoader();
            
            loader.load(
                './models/dodge_challenger_rt/scene.gltf',
                (gltf) => {
                    model = gltf.scene;
                    
                    // 遍历模型的所有子对象并设置材质属性
                    model.traverse((child) => {
                        if (child.isMesh) {
                            child.material.side = THREE.DoubleSide;
                            child.material.needsUpdate = true;
                            
                            if (child.material.transparent) {
                                child.material.depthWrite = false;
                                child.material.needsUpdate = true;
                            }
                        }
                    });
                    
                    scene.add(model);
                    
                    // 如果当前是3D模式，居中模型
                    if (!isARMode) {
                        centerModel();
                    } else {
                        adjustModelForAR();
                    }
                    
                    // 如果模型包含动画
                    if (gltf.animations && gltf.animations.length > 0) {
                        mixer = new THREE.AnimationMixer(model);
                        gltf.animations.forEach((clip, index) => {
                            if (index === 0) {
                                mixer.clipAction(clip).play();
                            }
                        });
                    }
                    
                    document.getElementById('loading').style.display = 'none';
                },
                (xhr) => {
                    console.log((xhr.loaded / xhr.total * 100) + '% 已加载');
                },
                (error) => {
                    console.error('模型加载失败:', error);
                    document.getElementById('error').textContent = '模型加载失败: ' + error;
                    document.getElementById('error').style.display = 'block';
                    document.getElementById('loading').style.display = 'none';
                }
            );
        }
        
        function onWindowResize() {
            if (isARMode && arToolkitSource) {
                arToolkitSource.onResizeElement();
                arToolkitSource.copyElementSizeTo(renderer.domElement);
                if (arToolkitContext && arToolkitContext.arController !== null) {
                    arToolkitSource.copyElementSizeTo(arToolkitContext.arController.canvas);
                }
            } else {
                // 3D模式调整
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
            }
            
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        function animate3D() {
            if (isARMode) return;
            
            requestAnimationFrame(animate3D);
            
            // 更新动画混合器
            if (mixer) {
                const delta = clock.getDelta();
                mixer.update(delta);
            }
            
            // 更新控制器
            if (controls) controls.update();
            
            // 渲染场景
            renderer.render(scene, camera);
        }
        
        function animateAR() {
            if (!isARMode) return;
            
            requestAnimationFrame(animateAR);
            
            // 更新AR
            if (arToolkitContext && arToolkitSource && arToolkitSource.ready) {
                arToolkitContext.update(arToolkitSource.domElement);
            }
            
            // 更新动画混合器
            if (mixer) {
                const delta = clock.getDelta();
                mixer.update(delta);
            }
            
            // 渲染场景
            renderer.render(scene, camera);
        }
    </script>
</body>